<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Speed Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .speed-display {
            text-align: center;
            margin: 30px 0;
        }

        .speed-value {
            font-size: 3.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .speed-unit {
            font-size: 1.2em;
            color: #666;
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .metric {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-start:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-style: italic;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 10px;
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>⚡ Speed Test</h1>

        <div class="speed-display">
            <div class="speed-value" id="speedValue">0</div>
            <div class="speed-unit">Mbps</div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>

        <div class="status" id="status">Ready to test</div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-label">Download</div>
                <div class="metric-value" id="downloadSpeed">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">Upload</div>
                <div class="metric-value" id="uploadSpeed">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">Ping</div>
                <div class="metric-value" id="pingValue">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">Jitter</div>
                <div class="metric-value" id="jitterValue">-</div>
            </div>
        </div>

        <button class="btn btn-start" id="startBtn">Start Test</button>

        <div class="info">
            ℹ️ This test measures your connection speed by downloading and uploading test data.
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            downloadTestUrl: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
            downloadTestSizeMB: 1.2,
            uploadTestSizeKB: 500,
            uploadTestUrls: [
                'https://www.cloudflare.com/cdn-cgi/trace',
                'https://ipinfo.io/json',
                'https://api.github.com/zen'
            ],
            pingTestUrl: 'https://cdnjs.cloudflare.com/favicon.ico',
            pingTests: 5
        };

        // Speed Test Module
        const SpeedTest = {
            // Test ping latency
            async testPing() {
                const results = [];

                for (let i = 0; i < CONFIG.pingTests; i++) {
                    const start = performance.now();
                    try {
                        await fetch(CONFIG.pingTestUrl + '?t=' + Date.now(), {
                            method: 'HEAD',
                            cache: 'no-cache'
                        });
                        const end = performance.now();
                        results.push(end - start);
                    } catch (e) {
                        results.push(0);
                    }
                }

                const avgPing = results.reduce((a, b) => a + b, 0) / results.length;
                const jitter = this.calculateJitter(results);

                return { ping: avgPing, jitter };
            },

            // Calculate jitter from ping results
            calculateJitter(pings) {
                if (pings.length < 2) return 0;

                let sumDiff = 0;
                for (let i = 1; i < pings.length; i++) {
                    sumDiff += Math.abs(pings[i] - pings[i - 1]);
                }

                return sumDiff / (pings.length - 1);
            },

            // Test download speed
            async testDownload() {
                const url = CONFIG.downloadTestUrl + '?t=' + Date.now();
                const start = performance.now();

                try {
                    const response = await fetch(url, { cache: 'no-cache' });
                    const data = await response.blob();
                    const end = performance.now();

                    const durationSeconds = (end - start) / 1000;
                    const bitsLoaded = data.size * 8;
                    const speedBps = bitsLoaded / durationSeconds;
                    const speedMbps = speedBps / (1024 * 1024);

                    return speedMbps;
                } catch (e) {
                    console.error('Download test failed:', e);
                    return 0;
                }
            },

            // Test upload speed
            async testUpload() {
                const uploadSizeBytes = CONFIG.uploadTestSizeKB * 1024;
                const data = this.generateTestData(uploadSizeBytes);

                // Try multiple upload endpoints
                for (const url of CONFIG.uploadTestUrls) {
                    try {
                        const start = performance.now();

                        // Use XMLHttpRequest for better upload progress tracking
                        const speed = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();

                            xhr.upload.addEventListener('loadstart', () => {
                                // Upload started
                            });

                            xhr.addEventListener('load', () => {
                                if (xhr.status >= 200 && xhr.status < 300) {
                                    const end = performance.now();
                                    const durationSeconds = (end - start) / 1000;
                                    const bitsUploaded = uploadSizeBytes * 8;
                                    const speedBps = bitsUploaded / durationSeconds;
                                    const speedMbps = speedBps / (1024 * 1024);
                                    resolve(speedMbps);
                                } else {
                                    reject(new Error('Upload failed'));
                                }
                            });

                            xhr.addEventListener('error', () => reject(new Error('Network error')));
                            xhr.addEventListener('timeout', () => reject(new Error('Timeout')));

                            xhr.open('POST', url);
                            xhr.timeout = 10000; // 10 second timeout
                            xhr.send(data);
                        });

                        return speed;
                    } catch (e) {
                        console.log(`Upload to ${url} failed, trying next...`);
                        continue;
                    }
                }

                // If all endpoints fail, use a bandwidth estimation based on download
                console.warn('All upload endpoints failed, using estimation');
                return 0;
            },

            // Generate random test data
            generateTestData(size) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < size; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
        };

        // UI Controller Module
        const UIController = {
            elements: {
                speedValue: document.getElementById('speedValue'),
                downloadSpeed: document.getElementById('downloadSpeed'),
                uploadSpeed: document.getElementById('uploadSpeed'),
                pingValue: document.getElementById('pingValue'),
                jitterValue: document.getElementById('jitterValue'),
                status: document.getElementById('status'),
                startBtn: document.getElementById('startBtn'),
                progressBar: document.getElementById('progressBar')
            },

            updateSpeed(speed) {
                this.elements.speedValue.textContent = speed.toFixed(2);
            },

            updateMetric(metric, value, unit = '') {
                this.elements[metric].textContent = value + unit;
            },

            updateStatus(message) {
                this.elements.status.textContent = message;
            },

            updateProgress(percent) {
                this.elements.progressBar.style.width = percent + '%';
            },

            setButtonState(disabled) {
                this.elements.startBtn.disabled = disabled;
                this.elements.startBtn.textContent = disabled ? 'Testing...' : 'Start Test';
            },

            reset() {
                this.updateSpeed(0);
                this.updateMetric('downloadSpeed', '-');
                this.updateMetric('uploadSpeed', '-');
                this.updateMetric('pingValue', '-');
                this.updateMetric('jitterValue', '-');
                this.updateProgress(0);
            }
        };

        // Test Runner Module
        const TestRunner = {
            async run() {
                UIController.setButtonState(true);
                UIController.reset();

                try {
                    // Step 1: Ping test
                    UIController.updateStatus('Testing latency...');
                    UIController.updateProgress(10);
                    const { ping, jitter } = await SpeedTest.testPing();
                    UIController.updateMetric('pingValue', ping.toFixed(0), ' ms');
                    UIController.updateMetric('jitterValue', jitter.toFixed(1), ' ms');

                    // Step 2: Download test
                    UIController.updateStatus('Testing download speed...');
                    UIController.updateProgress(40);
                    const downloadSpeed = await SpeedTest.testDownload();
                    UIController.updateMetric('downloadSpeed', downloadSpeed.toFixed(2), ' Mbps');
                    UIController.updateSpeed(downloadSpeed);

                    // Step 3: Upload test
                    UIController.updateStatus('Testing upload speed...');
                    UIController.updateProgress(70);
                    const uploadSpeed = await SpeedTest.testUpload();

                    if (uploadSpeed > 0) {
                        UIController.updateMetric('uploadSpeed', uploadSpeed.toFixed(2), ' Mbps');
                    } else {
                        UIController.updateMetric('uploadSpeed', 'N/A');
                        UIController.updateStatus('Test complete! (Upload test unavailable)');
                    }

                    // Complete
                    UIController.updateProgress(100);
                    if (uploadSpeed > 0) {
                        UIController.updateStatus('Test complete!');
                    }

                } catch (error) {
                    UIController.updateStatus('Test failed. Please try again.');
                    console.error('Test error:', error);
                } finally {
                    UIController.setButtonState(false);
                }
            }
        };

        // Event Listeners
        UIController.elements.startBtn.addEventListener('click', () => {
            TestRunner.run();
        });
    </script>
</body>

</html>